<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Production Planner — Year at a Glance</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --panel2:#111827; --line:#1f2937; --text:#e5e7eb; --muted:#94a3b8;
      --green:#22c55e; --blue:#38bdf8; --yellow:#f59e0b; --red:#ef4444; --purple:#a78bfa; --pink:#ec4899; --teal:#14b8a6;
      --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    html,body{height:100%}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:
      radial-gradient(900px 500px at 100% -10%, #1e293b55, transparent),
      radial-gradient(900px 500px at -10% 30%, #0ea5e955, transparent),
      var(--bg);}
    .container{max-width:1200px; margin:0 auto; padding:24px}
    .card{background:linear-gradient(180deg, var(--panel), var(--panel2)); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow)}
    header{display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--line)}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg, var(--blue), var(--green)); display:grid; place-items:center; font-weight:800}
    .pill{font-size:12px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--muted)}
    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .controls input, .controls select{background:#0b1020; color:var(--text); border:1px solid var(--line); border-radius:10px; padding:8px 10px}
    .btn{background:#0b1020; border:1px solid var(--line); padding:9px 12px; border-radius:10px; color:var(--text); cursor:pointer}
    .btn.primary{background:linear-gradient(135deg, #0ea5e9, #22c55e); border-color:#0ea5e9}
    .btn.danger{border-color:#ef4444; color:#fecaca}
    .grid{display:grid; grid-template-columns: 180px repeat(12, 1fr);}
    .grid .cell{min-height:56px; border-bottom:1px solid var(--line); border-right:1px solid var(--line)}
    .grid .cell.header{background:#0d1628; font-weight:700; color:#cbd5e1; display:flex; align-items:center; justify-content:center; position:sticky; top:0; z-index:3}
    .grid .phase{display:flex; align-items:center; padding:0 12px; font-weight:600; color:#cbd5e1; border-right:1px solid var(--line); background:#0d1628; position:sticky; left:0; z-index:2}
    .scroller{overflow:auto; max-height:70vh;}

    /* Bars */
    .bars{position:relative}
    .bar{position:relative; height:36px; border-radius:10px; display:flex; align-items:center; gap:8px; padding:0 10px; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; border:1px solid #0006}
    .bar .dot{width:8px; height:8px; border-radius:999px; opacity:.9}
    .bar .meta{opacity:.9; color:#e2e8f0}
    .ghost{opacity:.15}

    .legend{display:flex; gap:10px; flex-wrap:wrap; color:#cbd5e1}
    .legend .swatch{display:flex; align-items:center; gap:6px; font-size:13px; border:1px solid var(--line); padding:6px 8px; border-radius:10px; background:#0b1020}
    .swatch .sq{width:10px; height:10px; border-radius:3px}

    /* Modal */
    dialog{border:none; border-radius:14px; background:linear-gradient(180deg, #0f172a, #0b1220); color:var(--text); box-shadow:var(--shadow); width:min(520px, 92vw)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    form.grid{grid-template-columns: 1fr 1fr; gap:12px}
    form.grid label{font-size:12px; color:#93c5fd}
    form.grid input, form.grid select, form.grid textarea{background:#0b1020; color:#var(--text); border:1px solid var(--line); border-radius:10px; padding:8px 10px}
    form.grid .full{grid-column:1 / -1}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <div class="brand">
          <div class="logo">PP</div>
          <div>
            <div style="font-weight:800; letter-spacing:.2px">Production Planner</div>
            <div class="pill">Year-at-a-Glance · Local-first · Free</div>
          </div>
        </div>
        <div class="controls">
          <select id="yearSelect"></select>
          <input id="search" placeholder="Filter by project or title"/>
          <select id="typeFilter"><option value="">All types</option></select>
          <select id="phaseFilter"><option value="">All phases</option></select>
          <button class="btn" id="hideEmpty">Hide empty phases</button>
          <button class="btn" id="exportBtn">Export JSON</button>
          <input type="file" id="importFile" style="display:none" accept=".json" />
          <button class="btn" id="importBtn">Import</button>
          <button class="btn primary" id="addBtn">Add entry</button>
        </div>
      </header>

      <div class="scroller">
        <div class="grid" id="grid">
          <!-- grid will render here -->
        </div>
      </div>

      <div style="padding:12px 18px; display:flex; justify-content:space-between; align-items:center; gap:10px">
        <div class="legend" id="legend"></div>
        <button class="btn danger" id="resetBtn" title="Clear all data">Reset</button>
      </div>
    </div>
  </div>

  <dialog id="entryModal">
    <form method="dialog" class="grid" id="entryForm">
      <h3 class="full" style="margin:10px 0 0;">Add / Edit Entry</h3>
      <input type="hidden" id="id" />
      <label>Project ID<input id="projectId" placeholder="e.g., PRJ-001"/></label>
      <label>Title<input id="title" placeholder="e.g., Spring Fundraiser TVC" required/></label>
      <label>Type
        <select id="type" required></select>
      </label>
      <label>Phase
        <select id="phase" required></select>
      </label>
      <label>Year
        <select id="year"></select>
      </label>
      <label>Start Month
        <select id="startMonth"></select>
      </label>
      <label>End Month
        <select id="endMonth"></select>
      </label>
      <label class="full">Notes<textarea id="notes" rows="2" placeholder="Optional"></textarea></label>
      <div class="full" style="display:flex; gap:10px; justify-content:flex-end; margin-top:6px">
        <button class="btn" value="cancel">Cancel</button>
        <button class="btn primary" id="saveBtn" value="default">Save</button>
      </div>
    </form>
  </dialog>

  <script>
    /*****************
     * Configuration *
     *****************/
    const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const DEFAULT_PHASES = [
      "Planning & Concepting",
      "Pre-Production & Filming",
      "Post-Production",
      "Delivery & Launch"
    ];
    const TYPES = {
      "Campaign": "var(--blue)",
      "TV Spot": "var(--yellow)",
      "Digital": "var(--green)",
      "Social": "var(--pink)",
      "Radio": "var(--purple)",
      "Other": "var(--teal)"
    };

    const STORAGE_KEY = "production_planner_v1";
    const store = {
      load(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { entries:[], phases:DEFAULT_PHASES, types:Object.keys(TYPES), years:[new Date().getFullYear()] }; }catch{ return { entries:[], phases:DEFAULT_PHASES, types:Object.keys(TYPES), years:[new Date().getFullYear()] }; } },
      save(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
    }

    let state = store.load();

    // Utilities
    const uid = () => Math.random().toString(36).slice(2,9);
    const byId = id => document.getElementById(id);

    // Elements
    const grid = byId('grid');
    const yearSelect = byId('yearSelect');
    const typeFilter = byId('typeFilter');
    const phaseFilter = byId('phaseFilter');
    const search = byId('search');
    const hideEmptyBtn = byId('hideEmpty');
    const legend = byId('legend');

    const modal = byId('entryModal');
    const form = byId('entryForm');

    // Populate selects
    function populateStaticUI(){
      // Years (show stored + +/- 1 around current)
      const nowY = new Date().getFullYear();
      const years = Array.from(new Set([nowY-1, nowY, nowY+1, ...state.years])).sort();
      [yearSelect, byId('year')].forEach(sel => { sel.innerHTML=''; years.forEach(y=>{ const o=document.createElement('option'); o.value=o.textContent=y; sel.appendChild(o); }); });
      yearSelect.value = nowY;
      byId('year').value = nowY;

      // Months
      ;['startMonth','endMonth'].forEach(id=>{
        const sel = byId(id); sel.innerHTML='';
        MONTHS.forEach((m,i)=>{ const o=document.createElement('option'); o.value=i+1; o.textContent=`${i+1} — ${m}`; sel.appendChild(o); });
      });

      // Phases
      const phaseOpts = s=>{ s.innerHTML=''; state.phases.forEach(p=>{ const o=document.createElement('option'); o.value=o.textContent=p; s.appendChild(o);}); };
      phaseOpts(phaseFilter); phaseOpts(byId('phase'));

      // Types
      const typeOpts = s=>{ s.innerHTML=''; s.appendChild(new Option('All types',''));
        Object.keys(TYPES).forEach(t=>{ const o=document.createElement('option'); o.value=o.textContent=t; s.appendChild(o);}); };
      typeOpts(typeFilter);
      const typeSel = byId('type'); typeSel.innerHTML=''; Object.keys(TYPES).forEach(t=> typeSel.appendChild(new Option(t,t)) );

      // Legend
      legend.innerHTML='';
      Object.entries(TYPES).forEach(([name,color])=>{
        const el = document.createElement('div'); el.className='swatch';
        el.innerHTML = `<span class="sq" style="background:${color}"></span>${name}`;
        legend.appendChild(el);
      })
    }

    function headerRow(){
      // left sticky empty + month headers
      grid.innerHTML='';
      const left = document.createElement('div'); left.className='cell header'; left.style.position='sticky'; left.style.left='0'; left.textContent='Phase / Month'; grid.appendChild(left);
      for(let i=0;i<12;i++){ const h=document.createElement('div'); h.className='cell header'; h.textContent=MONTHS[i]; grid.appendChild(h);}    
    }

    function render(){
      headerRow();
      const selectedYear = parseInt(yearSelect.value,10);
      const q = search.value.trim().toLowerCase();
      const typeF = typeFilter.value;
      const phaseF = phaseFilter.value;
      const hideEmpty = hideEmptyBtn.dataset.on === '1';

      // Build each phase row
      state.phases.forEach(phase=>{
        const label = document.createElement('div'); label.className='phase cell'; label.textContent=phase; grid.appendChild(label);
        for(let m=1;m<=12;m++){ const c=document.createElement('div'); c.className='cell bars'; grid.appendChild(c); }

        const entries = state.entries.filter(e=> e.phase===phase && e.year===selectedYear)
          .filter(e=> !typeF || e.type===typeF)
          .filter(e=> !q || `${e.projectId} ${e.title}`.toLowerCase().includes(q));

        if(hideEmpty && entries.length===0){
          Array.from(grid.children).slice(-13).forEach(el=>el.classList.add('ghost'));
          return;
        }
      });

      buildOverlay();
    }

    function buildOverlay(){
      const selectedYear = parseInt(yearSelect.value,10);
      document.querySelectorAll('.bar').forEach(b=>b.remove());

      state.entries.filter(e=> e.year===selectedYear)
        .filter(e=> !typeFilter.value || e.type===typeFilter.value)
        .filter(e=> !search.value || `${e.projectId} ${e.title}`.toLowerCase().includes(search.value.trim().toLowerCase()))
        .filter(e=> !phaseFilter.value || e.phase===phaseFilter.value)
        .forEach(e=>{
          const rowIdx = state.phases.indexOf(e.phase);
          if(rowIdx<0) return;
          const startCol = 1 + e.startMonth; // +1 for left sticky column
          const endCol = 1 + e.endMonth + 1; // end exclusive

          const bar = document.createElement('div');
          bar.className='bar';
          bar.style.background = `linear-gradient(135deg, ${TYPES[e.type]||'var(--teal)'}66, ${TYPES[e.type]||'var(--teal)'}AA)`;
          bar.style.gridColumn = `${startCol} / ${endCol}`;
          bar.style.gridRow = `${rowIdx+2}`; // +1 header row
          bar.style.margin = '8px 6px';
          bar.innerHTML = `<span class="dot" style="background:${TYPES[e.type]||'var(--teal)'}"></span><span class="meta">${e.projectId? e.projectId+ ' — ' : ''}${e.title} (${e.type})</span>`;
          bar.title = `${e.title} — ${e.phase} — ${MONTHS[e.startMonth-1]} to ${MONTHS[e.endMonth-1]} (${e.year})\nClick to edit`;
          bar.onclick = ()=> openEdit(e.id);
          grid.appendChild(bar);
        });

      grid.style.display = 'grid';
      grid.style.gridTemplateColumns = '180px repeat(12, 1fr)';
      grid.style.position = 'relative';
    }

    function openEdit(id){
      const e = state.entries.find(x=>x.id===id);
      if(!e) return;
      fillForm(e);
      modal.showModal();
    }

    function fillForm(data){
      byId('id').value = data.id || '';
      byId('projectId').value = data.projectId || '';
      byId('title').value = data.title || '';
      byId('type').value = data.type || Object.keys(TYPES)[0];
      byId('phase').value = data.phase || state.phases[0];
      byId('year').value = data.year || new Date().getFullYear();
      byId('startMonth').value = data.startMonth || 1;
      byId('endMonth').value = data.endMonth || Math.min(12, (data.startMonth||1));
      byId('notes').value = data.notes || '';
    }

    function saveFromForm(){
      const data = {
        id: byId('id').value || uid(),
        projectId: byId('projectId').value.trim(),
        title: byId('title').value.trim(),
        type: byId('type').value,
        phase: byId('phase').value,
        year: parseInt(byId('year').value,10),
        startMonth: parseInt(byId('startMonth').value,10),
        endMonth: parseInt(byId('endMonth').value,10),
        notes: byId('notes').value.trim()
      };

      // Update or insert
      const i = state.entries.findIndex(e=> e.id===data.id);
      if(i>=0){
        const prev = state.entries[i];
        state.entries[i] = data;
        if(data.projectId){
          state.entries = state.entries.map(e=> e.projectId===data.projectId ? { ...e, title:data.title, type:data.type } : e);
        }
      } else {
        state.entries.push(data);
        if(data.projectId){
          state.entries = state.entries.map(e=> e.projectId===data.projectId ? { ...e, title:data.title, type:data.type } : e);
        }
      }

      if(!state.years.includes(data.year)) state.years.push(data.year);
      store.save(state);
      populateStaticUI();
      render();
    }

    function removeEntry(id){
      state.entries = state.entries.filter(e=> e.id!==id);
      store.save(state); render();
    }

    function resetAll(){
      if(!confirm('This will clear all projects. Continue?')) return;
      state = { entries:[], phases:DEFAULT_PHASES, types:Object.keys(TYPES), years:[new Date().getFullYear()] };
      store.save(state); populateStaticUI(); render();
    }

    // Events
    document.getElementById('addBtn').onclick = ()=>{ fillForm({ startMonth:new Date().getMonth()+1, endMonth:new Date().getMonth()+1, phase:state.phases[0], type:Object.keys(TYPES)[0], year:parseInt(yearSelect.value,10)}); modal.showModal(); };
    form.addEventListener('submit', (ev)=>{ ev.preventDefault(); saveFromForm(); modal.close(); });

    [yearSelect, typeFilter, phaseFilter].forEach(el=> el.onchange = render);
    search.oninput = ()=> render();
    hideEmptyBtn.onclick = ()=>{ hideEmptyBtn.dataset.on = hideEmptyBtn.dataset.on==='1' ? '0':'1'; hideEmptyBtn.textContent = hideEmptyBtn.dataset.on==='1' ? 'Show empty phases' : 'Hide empty phases'; render(); };

    document.getElementById('exportBtn').onclick = ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `production_planner_${Date.now()}.json`; a.click();
    };

    const importFile = document.getElementById('importFile');
    document.getElementById('importBtn').onclick = ()=> importFile.click();
    importFile.onchange = async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const text = await file.text();
      try{ const data = JSON.parse(text); if(!data.entries) throw new Error('Invalid file'); state = data; store.save(state); populateStaticUI(); render(); }
      catch(err){ alert('Import failed: '+err.message); }
      finally{ importFile.value=''; }
    };

    document.getElementById('resetBtn').onclick = resetAll;

    // Boot
    populateStaticUI();
    render();
  </script>
</body>
</html>
